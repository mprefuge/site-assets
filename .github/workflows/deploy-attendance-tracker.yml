name: Deploy Attendance Tracker

on:
  push:
    branches: [ main ]
    paths:
      - 'attendancetracker/**'
      - 'styles/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'attendancetracker/**'
      - 'styles/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Configure Attendance Tracker
      run: |
        cd attendancetracker
        
        # Create configuration injection script
        cat << 'EOF' > inject-config.js
        // This script injects environment variables into the browser-accessible config
        const fs = require('fs');
        
        // Read the original config file
        let configContent = fs.readFileSync('config.js', 'utf8');
        
        // Inject environment variables as a global AttendanceConfig object
        // Note: We set window.ATTENDANCE_CONFIG which is read by config.js
        const envConfig = {
          ENDPOINT: process.env.ENDPOINT,
          STYLEENDPOINT: process.env.STYLEENDPOINT
        };
        
        // Remove undefined values
        Object.keys(envConfig).forEach(key => {
          if (envConfig[key] === undefined) {
            delete envConfig[key];
          }
        });
        
        // Prepend the environment config injection
        const injection = `
// Environment configuration injected at build time
if (typeof window !== 'undefined') {
  window.ATTENDANCE_CONFIG = ${JSON.stringify(envConfig, null, 2)};
}
`;
        
        fs.writeFileSync('config.js', injection + configContent);
        console.log('Configuration injected successfully');
        
        // Also update the HTML file with the correct stylesheet paths if STYLEENDPOINT is set
        if (process.env.STYLEENDPOINT) {
          let htmlContent = fs.readFileSync('attendancetracker.html', 'utf8');
          const styleEndpoint = process.env.STYLEENDPOINT;
          
          // Update stylesheet hrefs to use the STYLEENDPOINT
          htmlContent = htmlContent.replace(
            /href="\.\.\/styles\/attendancetracker\.css"/g,
            `href="${styleEndpoint}attendancetracker.css"`
          );
          htmlContent = htmlContent.replace(
            /href="\.\.\/styles\/form-styles\.css"/g,
            `href="${styleEndpoint}form-styles.css"`
          );
          
          fs.writeFileSync('attendancetracker.html', htmlContent);
          console.log('Stylesheet paths updated successfully');
        }
        EOF
        
        node inject-config.js
      env:
        # Map GitHub secrets/variables to environment variables
        ENDPOINT: ${{ vars.ENDPOINT }}
        STYLEENDPOINT: ${{ vars.STYLEENDPOINT }}
    
    - name: Validate configuration
      run: |
        cd attendancetracker
        echo "Validating configuration..."
        node -e "
          const fs = require('fs');
          const config = fs.readFileSync('config.js', 'utf8');
          console.log('Config file contents (first 500 chars):');
          console.log(config.substring(0, 500));
          console.log('...');
        "
    
    - name: Deploy to hosting
      run: |
        # Add your deployment commands here
        echo "Deploying configured attendance tracker..."
        # Example: upload to S3, deploy to Netlify, etc.
